<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<Migrations>
  <Migration EntityType="D" Name="Agregar tipo de documento para LMX_Comprobante" ReleaseNo="LMX#2.0.0" SeqNo="23">
    <Comments>https://github.com/adempiere/LMX/issues/18</Comments>
    <Step SeqNo="10" StepType="AD">
      <PO AD_Table_ID="101" Action="I" Record_ID="86234" Table="AD_Column">
        <Data AD_Column_ID="112" Column="Description" isNewNull="true"/>
        <Data AD_Column_ID="549" Column="Created">2018-01-09 15:16:13.943</Data>
        <Data AD_Column_ID="3388" Column="ValueMin" isNewNull="true"/>
        <Data AD_Column_ID="548" Column="IsActive">true</Data>
        <Data AD_Column_ID="551" Column="Updated">2018-01-09 15:16:13.943</Data>
        <Data AD_Column_ID="3389" Column="ValueMax" isNewNull="true"/>
        <Data AD_Column_ID="111" Column="Name">Document Type for LMX Localization ID</Data>
        <Data AD_Column_ID="124" Column="IsMandatory">false</Data>
        <Data AD_Column_ID="125" Column="IsTranslated">false</Data>
        <Data AD_Column_ID="117" Column="DefaultValue" isNewNull="true"/>
        <Data AD_Column_ID="1179" Column="VFormat" isNewNull="true"/>
        <Data AD_Column_ID="120" Column="IsParent">false</Data>
        <Data AD_Column_ID="126" Column="IsIdentifier">false</Data>
        <Data AD_Column_ID="6244" Column="IsSelectionColumn">false</Data>
        <Data AD_Column_ID="6483" Column="IsSyncDatabase">N</Data>
        <Data AD_Column_ID="119" Column="IsKey">false</Data>
        <Data AD_Column_ID="6245" Column="ReadOnlyLogic" isNewNull="true"/>
        <Data AD_Column_ID="56352" Column="FormatPattern" isNewNull="true"/>
        <Data AD_Column_ID="50218" Column="MandatoryLogic" isNewNull="true"/>
        <Data AD_Column_ID="110" Column="Version">0</Data>
        <Data AD_Column_ID="13448" Column="ColumnSQL" isNewNull="true"/>
        <Data AD_Column_ID="116" Column="ColumnName">LMX_DocType_ID</Data>
        <Data AD_Column_ID="113" Column="Help" isNewNull="true"/>
        <Data AD_Column_ID="3360" Column="IsUpdateable">true</Data>
        <Data AD_Column_ID="1692" Column="Callout" isNewNull="true"/>
        <Data AD_Column_ID="11617" Column="IsAlwaysUpdateable">false</Data>
        <Data AD_Column_ID="128" Column="IsEncrypted">N</Data>
        <Data AD_Column_ID="54358" Column="InfoFactoryClass" isNewNull="true"/>
        <Data AD_Column_ID="56187" Column="IsAllowLogging">true</Data>
        <Data AD_Column_ID="56149" Column="IsAutocomplete">false</Data>
        <Data AD_Column_ID="68024" Column="IsRange">false</Data>
        <Data AD_Column_ID="62199" Column="IsAllowCopy">true</Data>
        <Data AD_Column_ID="127" Column="SeqNo">0</Data>
        <Data AD_Column_ID="109" Column="AD_Column_ID">86234</Data>
        <Data AD_Column_ID="6482" Column="EntityType">LMX</Data>
        <Data AD_Column_ID="359" Column="AD_Client_ID">0</Data>
        <Data AD_Column_ID="360" Column="AD_Org_ID">0</Data>
        <Data AD_Column_ID="59702" Column="AD_Chart_ID" isNewNull="true"/>
        <Data AD_Column_ID="114" Column="AD_Table_ID">53907</Data>
        <Data AD_Column_ID="550" Column="CreatedBy">100</Data>
        <Data AD_Column_ID="2608" Column="AD_Element_ID">59645</Data>
        <Data AD_Column_ID="3369" Column="AD_Process_ID" isNewNull="true"/>
        <Data AD_Column_ID="227" Column="AD_Reference_Value_ID" isNewNull="true"/>
        <Data AD_Column_ID="115" Column="AD_Val_Rule_ID" isNewNull="true"/>
        <Data AD_Column_ID="118" Column="FieldLength">10</Data>
        <Data AD_Column_ID="226" Column="AD_Reference_ID">19</Data>
        <Data AD_Column_ID="552" Column="UpdatedBy">100</Data>
        <Data AD_Column_ID="84306" Column="UUID" isNewNull="true"/>
      </PO>
    </Step>
    <Step SeqNo="20" StepType="AD">
      <PO AD_Table_ID="752" Action="I" Record_ID="0" Table="AD_Column_Trl">
        <Data AD_Column_ID="12960" Column="Created">2018-01-09 15:16:14.947</Data>
        <Data AD_Column_ID="12959" Column="IsActive">true</Data>
        <Data AD_Column_ID="12952" Column="Updated">2018-01-09 15:16:14.947</Data>
        <Data AD_Column_ID="12954" Column="IsTranslated">false</Data>
        <Data AD_Column_ID="12957" Column="Name">Document Type for LMX Localization ID</Data>
        <Data AD_Column_ID="12961" Column="AD_Client_ID">0</Data>
        <Data AD_Column_ID="12951" Column="AD_Org_ID">0</Data>
        <Data AD_Column_ID="12958" Column="UpdatedBy">100</Data>
        <Data AD_Column_ID="12956" Column="CreatedBy">100</Data>
        <Data AD_Column_ID="12953" Column="AD_Language">es_MX</Data>
        <Data AD_Column_ID="12955" Column="AD_Column_ID">86234</Data>
        <Data AD_Column_ID="84310" Column="UUID" isNewNull="true"/>
      </PO>
    </Step>
    <Step SeqNo="30" StepType="AD">
      <PO AD_Table_ID="489" Action="I" Record_ID="60502" Table="AD_PrintFormatItem">
        <Data AD_Column_ID="200016" Column="IsDesc">false</Data>
        <Data AD_Column_ID="64457" Column="IsPrintBarcodeText">true</Data>
        <Data AD_Column_ID="74122" Column="DisplayLogic" isNewNull="true"/>
        <Data AD_Column_ID="6959" Column="Updated">2018-01-09 15:17:34.368</Data>
        <Data AD_Column_ID="6942" Column="Created">2018-01-09 15:17:34.368</Data>
        <Data AD_Column_ID="6964" Column="IsActive">true</Data>
        <Data AD_Column_ID="9964" Column="IsMaxCalc">false</Data>
        <Data AD_Column_ID="7058" Column="ImageURL" isNewNull="true"/>
        <Data AD_Column_ID="10258" Column="IsVarianceCalc">false</Data>
        <Data AD_Column_ID="7059" Column="ImageIsAttached">false</Data>
        <Data AD_Column_ID="6969" Column="IsPrinted">true</Data>
        <Data AD_Column_ID="6971" Column="IsGroupBy">false</Data>
        <Data AD_Column_ID="7032" Column="PrintAreaType">C</Data>
        <Data AD_Column_ID="6956" Column="IsSummarized">false</Data>
        <Data AD_Column_ID="6943" Column="IsNextLine">true</Data>
        <Data AD_Column_ID="6950" Column="IsPageBreak">false</Data>
        <Data AD_Column_ID="7030" Column="LineAlignmentType">X</Data>
        <Data AD_Column_ID="7061" Column="IsAveraged">false</Data>
        <Data AD_Column_ID="7655" Column="IsFixedWidth">false</Data>
        <Data AD_Column_ID="6951" Column="IsRelativePosition">true</Data>
        <Data AD_Column_ID="7565" Column="IsSuppressNull">false</Data>
        <Data AD_Column_ID="7566" Column="IsSetNLPosition">false</Data>
        <Data AD_Column_ID="7654" Column="IsNextPage">false</Data>
        <Data AD_Column_ID="9967" Column="IsMinCalc">false</Data>
        <Data AD_Column_ID="8197" Column="PrintNameSuffix" isNewNull="true"/>
        <Data AD_Column_ID="13057" Column="ShapeType">N</Data>
        <Data AD_Column_ID="13054" Column="IsFilledRectangle">false</Data>
        <Data AD_Column_ID="15015" Column="BarcodeType" isNewNull="true"/>
        <Data AD_Column_ID="56351" Column="FormatPattern" isNewNull="true"/>
        <Data AD_Column_ID="6970" Column="IsOrderBy">false</Data>
        <Data AD_Column_ID="6965" Column="IsHeightOneLine">true</Data>
        <Data AD_Column_ID="7031" Column="PrintFormatType">F</Data>
        <Data AD_Column_ID="6946" Column="PrintName">LMX_DocType_ID</Data>
        <Data AD_Column_ID="6940" Column="Name">LMX_DocType_ID</Data>
        <Data AD_Column_ID="7060" Column="IsCounted">false</Data>
        <Data AD_Column_ID="6968" Column="FieldAlignmentType">D</Data>
        <Data AD_Column_ID="9966" Column="IsRunningTotal">false</Data>
        <Data AD_Column_ID="10259" Column="IsDeviationCalc">false</Data>
        <Data AD_Column_ID="56359" Column="IsSuppressRepeats">false</Data>
        <Data AD_Column_ID="13237" Column="IsCentrallyMaintained">true</Data>
        <Data AD_Column_ID="13238" Column="IsImageField">false</Data>
        <Data AD_Column_ID="6961" Column="AD_Org_ID">0</Data>
        <Data AD_Column_ID="6944" Column="AD_Client_ID">0</Data>
        <Data AD_Column_ID="6954" Column="AD_PrintFormatItem_ID">60502</Data>
        <Data AD_Column_ID="6966" Column="MaxHeight">0</Data>
        <Data AD_Column_ID="6945" Column="AD_PrintFormatChild_ID" isNewNull="true"/>
        <Data AD_Column_ID="6949" Column="AD_Column_ID">86234</Data>
        <Data AD_Column_ID="6957" Column="YPosition">0</Data>
        <Data AD_Column_ID="6958" Column="AD_PrintColor_ID" isNewNull="true"/>
        <Data AD_Column_ID="6955" Column="CreatedBy">100</Data>
        <Data AD_Column_ID="6963" Column="AD_PrintFont_ID" isNewNull="true"/>
        <Data AD_Column_ID="6952" Column="UpdatedBy">100</Data>
        <Data AD_Column_ID="7639" Column="AD_PrintGraph_ID" isNewNull="true"/>
        <Data AD_Column_ID="6953" Column="MaxWidth">0</Data>
        <Data AD_Column_ID="13056" Column="ArcDiameter">0</Data>
        <Data AD_Column_ID="13055" Column="LineWidth">1</Data>
        <Data AD_Column_ID="6948" Column="SortNo">0</Data>
        <Data AD_Column_ID="6967" Column="XPosition">0</Data>
        <Data AD_Column_ID="6960" Column="AD_PrintFormat_ID">50268</Data>
        <Data AD_Column_ID="6962" Column="XSpace">0</Data>
        <Data AD_Column_ID="6939" Column="SeqNo">540</Data>
        <Data AD_Column_ID="7638" Column="BelowColumn">0</Data>
        <Data AD_Column_ID="9965" Column="RunningTotalLines">20</Data>
        <Data AD_Column_ID="6947" Column="YSpace">0</Data>
        <Data AD_Column_ID="84374" Column="UUID" isNewNull="true"/>
      </PO>
    </Step>
    <Step SeqNo="40" StepType="AD">
      <PO AD_Table_ID="522" Action="I" Record_ID="0" Table="AD_PrintFormatItem_Trl">
        <Data AD_Column_ID="7612" Column="Updated">2018-01-09 15:17:35.333</Data>
        <Data AD_Column_ID="7610" Column="IsTranslated">false</Data>
        <Data AD_Column_ID="7608" Column="Created">2018-01-09 15:17:35.333</Data>
        <Data AD_Column_ID="7614" Column="IsActive">true</Data>
        <Data AD_Column_ID="8198" Column="PrintNameSuffix" isNewNull="true"/>
        <Data AD_Column_ID="7613" Column="PrintName">LMX_DocType_ID</Data>
        <Data AD_Column_ID="7607" Column="AD_Org_ID">0</Data>
        <Data AD_Column_ID="7611" Column="AD_Client_ID">0</Data>
        <Data AD_Column_ID="7609" Column="CreatedBy">100</Data>
        <Data AD_Column_ID="7605" Column="AD_Language">es_MX</Data>
        <Data AD_Column_ID="7606" Column="UpdatedBy">100</Data>
        <Data AD_Column_ID="7615" Column="AD_PrintFormatItem_ID">60502</Data>
        <Data AD_Column_ID="84375" Column="UUID" isNewNull="true"/>
      </PO>
    </Step>
    <Step DBType="ALL" Parse="Y" SeqNo="50" StepType="SQL">
      <SQLStatement>DROP VIEW LMX_COMPROBANTE;
CREATE OR REPLACE VIEW LMX_COMPROBANTE AS
  SELECT
    'es_MX' AS AD_Language,
    i.AD_Client_ID,
    i.AD_Org_ID,
    i.C_Invoice_ID,
    COALESCE(substr(i.documentno,LENGTH(seq.prefix)+1), i.documentno) AS Folio,
    TO_CHAR((SELECT SUM(it.taxamt)
       FROM C_InvoiceTax it
    INNER JOIN C_Tax t ON t.C_Tax_ID  =it.C_Tax_ID
    WHERE C_Invoice_ID=i.C_Invoice_ID
    AND t.rate &lt; 0
    ),'99999999990.99')                                                AS TotalImpuestosRetenidos,
    TO_CHAR(i.GrandTotal,'99999999990.99')                             AS Total,
    TO_CHAR(i.TotalLines,'99999999990.99')                             AS SubTotal,
    TO_CHAR((SELECT SUM(it.taxamt)
       FROM c_invoicetax it
    INNER JOIN c_tax t ON t.c_tax_id  =it.c_tax_id
    WHERE c_invoice_id=i.c_invoice_id
    AND t.rate &gt;= 0
    ), '99999999990.99')                                                AS TotalImpuestosTrasladados,
--    'MXP'                                            AS Moneda                   , -- remove para CFDI v3.3
--    '3.2'                                            AS Version                  , -- remove para CFDI v3.3
    TO_CHAR(getdate(), 'yyyy-mm-dd"T"HH24:MI:SS') AS Fecha,
--  /*  'Pago en Una Sola Exhibicion'                    AS FormaDePago            , -- relaplace para CFDI v3.3
/*    (SELECT name
       FROM AD_Ref_List_trl
      WHERE AD_Language ='es_MX'
    AND AD_Ref_List_ID IN
      (SELECT ad_ref_list_id
         FROM AD_Ref_List
        WHERE AD_Reference_ID=195
      AND value = i.paymentrule
      )
    )                                         AS MetodoDePago          ,*/
    bp.Name                                   AS ReceptorNombre        ,
    bp.TaxID                                  AS ReceptorRfc           ,
    bp.NAICS                                  AS NumCtaPago            ,
    l.Address1                                AS ReceptorCalle         ,
    l.Address4                                AS ReceptorReferencia    ,
    l.RegionName                              AS ReceptorEstado        ,
    l.Postal                                  AS ReceptorCodigoPostal  ,
    l.Address2                                AS ReceptorColonia       ,
    l.Address3                                AS ReceptorMunicipio     ,
    l.City                                    AS ReceptorLocalidad     ,
    e.TaxID                                   AS EmisorRfc             ,
    tg.description                            AS Regimen               ,
    fi.Name                                   AS EmisorNombre          ,
    c.Name                                    AS ReceptorPais          ,
    ol.Postal                                 AS ExpedidoEnCodigoPostal,
    ol.Address2                               AS ExpedidoEnColonia     ,
    ol.Address3                               AS ExpedidoEnLocalidad   ,
    ol.Address4                               AS ExpedidoEnReferencia  ,
    ol.City                                   AS ExpedidoEnMunicipio   ,
    COALESCE(ol.RegionName,rol.name)          AS ExpedidoEnEstado      ,
    ol.address1                               AS ExpedidoEnCalle       ,
    oc.Name                                   AS ExpedidoEnPais        ,
    el.address2                               AS EmisorColonia         ,
    el.address1                               AS EmisorCalle           ,
    el.address3                               AS EmisorLocalidad       ,
    el.address4                               AS EmisorreRerencia      ,
    el.City                                   AS EmisorMunicipio       ,
    COALESCE(el.RegionName ,rel.name)        AS EmisorEstado          ,
    el.Postal                                 AS EmisorCodigoPostal    ,
    ec.Name                                   AS EmisorPais            ,
    pt.Name                                   AS CondicionesDePago     ,
    seq.prefix                                AS Serie                 ,
    -- TRIM(dt.description)                      AS TipoDeComprobante     , -- remove para CFDI v3.3
    ''                                        AS NoAprobacion          ,
    ''                                        AS AnoAprobacion         ,
    oln.ExternalNo                            AS ExpedidoEnNoExterior  ,
    oln.InternalNo                            AS ExpedidoEnNoInterior  ,
    en.ExternalNo                             AS EmisorNoExterior      ,
    en.InternalNo                             AS EmisorNoInterior      ,
    ln.ExternalNo                             AS ReceptorNoExterior    ,
    ln.InternalNo                             AS ReceptorNoInterior    ,
    -- cfdi v3.3
    '3.3'                                     AS Version,
    ol.postal                                 AS LugarExpedicion,
    CASE WHEN (SELECT NetDays FROM C_PaymentTerm WHERE C_PaymentTerm_ID=i.C_PaymentTerm_ID) &gt; 0
         THEN 'PPD'
         ELSE 'PUE'
    END                                       AS MetodoPago,
    lmxdt.tipodecomprobante                   AS TipoDeComprobante,
    currency.iso_code                         AS Moneda,
    CASE WHEN i.C_Currency_ID=130
        THEN ''
        ELSE TO_CHAR((currencyconvert(i.grandtotal, i.c_currency_id, 130, i.dateacct, i.c_conversiontype_id, i.ad_client_id, i.ad_org_id)/i.grandtotal),'00.000000')
        END                                  AS TipoCambio,
    (
        SELECT ad_ref_list_trl.description
        FROM AD_Ref_List_Trl
        WHERE AD_Ref_List_Trl.AD_language = 'es_MX'
        AND (AD_Ref_List_Trl.ad_ref_list_id IN ( SELECT AD_Ref_List.AD_Ref_List_ID FROM AD_Ref_List
        WHERE AD_Ref_List.AD_Reference_ID = 195 AND AD_Ref_List.Value = i.PaymentRule))
    )                                        AS FormaPago,
    tg.value                                 AS RegimenFiscal,
    lmxbp.usocfdi                            AS UsoCFDI,
    lmxdt.LMX_DocType_ID
  FROM C_Invoice i
  INNER JOIN C_BPartner bp ON bp.C_BPartner_id=i.C_BPartner_ID
  INNER JOIN C_BPartner_Location bpl ON bpl.C_BPartner_Location_ID=i.C_BPartner_Location_ID
  LEFT JOIN C_Location l ON l.c_location_id=bpl.c_location_id
  LEFT JOIN LMX_Tax fi ON (fi.AD_Client_ID=i.AD_Client_ID)
    /*LEFT JOIN LMX_Tax fi
    ON fi.lmx_Tax_id =
    (SELECT lmx_tax_id
    FROM lmx_tax
    WHERE ad_tree_org_id IN
    (SELECT ad_tree_id
    FROM ad_tree
    WHERE ad_tree_id IN
    (SELECT ad_tree_id FROM ad_treenode WHERE node_id = i.ad_org_id
    )
    AND treetype = 'OO'
    )
    )*/
  LEFT JOIN C_Country c ON c.C_Country_id=l.C_Country_ID
  LEFT JOIN AD_OrgInfo o ON o.AD_Org_ID=i.AD_Org_ID
  LEFT JOIN C_Location ol ON ol.C_Location_ID=o.C_Location_ID
  LEFT JOIN C_Region rol ON rol.C_Region_ID=ol.C_Region_ID
  LEFT JOIN C_Country oc ON oc.C_Country_ID=ol.C_Country_id
    /*LEFT JOIN C_Location el
    ON el.c_location_id=
    (SELECT c_location_id
    FROM lmx_tax
    WHERE ad_tree_org_id IN
    (SELECT ad_tree_id
    FROM ad_tree
    WHERE ad_tree_id IN
    (SELECT ad_tree_id FROM ad_treenode WHERE node_id = i.ad_org_id
    )
    AND treetype = 'OO'
    )
    )*/
  LEFT JOIN C_Location el ON el.C_Location_ID=fi.C_Location_ID
  LEFT JOIN C_Region rel ON rel.C_Region_ID=el.C_Region_ID
  LEFT JOIN C_Country ec ON ec.C_Country_ID=el.C_Country_ID
  LEFT JOIN C_DocType dt ON dt.C_DocType_ID=i.C_DocTypeTarget_ID
  LEFT JOIN C_PaymentTerm pt ON pt.C_PaymentTerm_ID=i.C_PaymentTerm_ID
  LEFT JOIN AD_Sequence seq ON seq.AD_Sequence_ID=dt.DocNoSequence_ID
  LEFT JOIN LMX_Location oln ON oln.C_Location_ID = ol.C_Location_ID
  LEFT JOIN LMX_Location en ON en.C_Location_ID = el.c_Location_ID
  LEFT JOIN LMX_Location ln ON ln.c_Location_ID = l.c_Location_ID
  LEFT JOIN C_BPartner e ON fi.C_BPartner_ID = e.C_BPartner_ID
  LEFT JOIN C_TaxGroup tg ON e.C_TaxGroup_ID = tg.C_TaxGroup_ID
  LEFT JOIN C_Currency currency ON i.C_Currency_ID = currency.C_Currency_ID
  -- cfdi v3.3
  LEFT JOIN LMX_DocType lmxdt ON lmxdt.C_DocType_ID = dt.C_DocType_ID
  LEFT JOIN LMX_BPartner lmxbp ON lmxbp.C_BPartner_ID = bp.C_BPartner_ID;</SQLStatement>
      <RollbackStatement>DROP VIEW LMX_COMPROBANTE;
CREATE OR REPLACE VIEW LMX_COMPROBANTE AS
  SELECT
    'es_MX' AS AD_Language,
    i.AD_Client_ID,
    i.AD_Org_ID,
    i.C_Invoice_ID,
    COALESCE(substr(i.documentno,LENGTH(seq.prefix)+1), i.documentno) AS Folio,
    TO_CHAR((SELECT SUM(it.taxamt)
       FROM C_InvoiceTax it
    INNER JOIN C_Tax t ON t.C_Tax_ID  =it.C_Tax_ID
    WHERE C_Invoice_ID=i.C_Invoice_ID
    AND t.rate &lt; 0
    ) , '99999999990.99')                                               AS TotalImpuestosRetenidos,
    TO_CHAR(i.GrandTotal, '99999999990.99')                             AS Total,
    TO_CHAR(i.TotalLines, '99999999990.99')                             AS SubTotal,
    TO_CHAR((SELECT SUM(it.taxamt)
       FROM c_invoicetax it
    INNER JOIN c_tax t ON t.c_tax_id  =it.c_tax_id
    WHERE c_invoice_id=i.c_invoice_id
    AND t.rate &gt;= 0
    ), '99999999990.99')                                                AS TotalImpuestosTrasladados,
--    'MXP'                                            AS Moneda                   , -- remove para CFDI v3.3
--    '3.2'                                            AS Version                  , -- remove para CFDI v3.3
    TO_CHAR(getdate(), 'yyyy-mm-dd"T"HH24:MI:SS') AS Fecha,
--  /*  'Pago en Una Sola Exhibicion'                    AS FormaDePago            , -- relaplace para CFDI v3.3
/*    (SELECT name
       FROM AD_Ref_List_trl
      WHERE AD_Language ='es_MX'
    AND AD_Ref_List_ID IN
      (SELECT ad_ref_list_id
         FROM AD_Ref_List
        WHERE AD_Reference_ID=195
      AND value = i.paymentrule
      )
    )                                         AS MetodoDePago          ,*/
    bp.Name                                   AS ReceptorNombre        ,
    bp.TaxID                                  AS ReceptorRfc           ,
    bp.NAICS                                  AS NumCtaPago            ,
    l.Address1                                AS ReceptorCalle         ,
    l.Address4                                AS ReceptorReferencia    ,
    l.RegionName                              AS ReceptorEstado        ,
    l.Postal                                  AS ReceptorCodigoPostal  ,
    l.Address2                                AS ReceptorColonia       ,
    l.Address3                                AS ReceptorMunicipio     ,
    l.City                                    AS ReceptorLocalidad     ,
    e.TaxID                                   AS EmisorRfc             ,
    tg.description                            AS Regimen               ,
    fi.Name                                   AS EmisorNombre          ,
    c.Name                                    AS ReceptorPais          ,
    ol.Postal                                 AS ExpedidoEnCodigoPostal,
    ol.Address2                               AS ExpedidoEnColonia     ,
    ol.Address3                               AS ExpedidoEnLocalidad   ,
    ol.Address4                               AS ExpedidoEnReferencia  ,
    ol.City                                   AS ExpedidoEnMunicipio   ,
    COALESCE(ol.RegionName,rol.name)          AS ExpedidoEnEstado      ,
    ol.address1                               AS ExpedidoEnCalle       ,
    oc.Name                                   AS ExpedidoEnPais        ,
    el.address2                               AS EmisorColonia         ,
    el.address1                               AS EmisorCalle           ,
    el.address3                               AS EmisorLocalidad       ,
    el.address4                               AS EmisorreRerencia      ,
    el.City                                   AS EmisorMunicipio       ,
    COALESCE(el.RegionName ,rel.name)        AS EmisorEstado          ,
    el.Postal                                 AS EmisorCodigoPostal    ,
    ec.Name                                   AS EmisorPais            ,
    pt.Name                                   AS CondicionesDePago     ,
    seq.prefix                                AS Serie                 ,
    -- TRIM(dt.description)                      AS TipoDeComprobante     , -- remove para CFDI v3.3
    ''                                        AS NoAprobacion          ,
    ''                                        AS AnoAprobacion         ,
    oln.ExternalNo                            AS ExpedidoEnNoExterior  ,
    oln.InternalNo                            AS ExpedidoEnNoInterior  ,
    en.ExternalNo                             AS EmisorNoExterior      ,
    en.InternalNo                             AS EmisorNoInterior      ,
    ln.ExternalNo                             AS ReceptorNoExterior    ,
    ln.InternalNo                             AS ReceptorNoInterior    ,
    -- cfdi v3.3
    '3.3'                                     AS Version,
    ol.postal                                 AS LugarExpedicion,
    CASE WHEN (SELECT NetDays FROM C_PaymentTerm WHERE C_PaymentTerm_ID=i.C_PaymentTerm_ID) &gt; 0
         THEN 'PPD'
         ELSE 'PUE'
    END                                       AS MetodoPago,
    lmxdt.tipodecomprobante                   AS TipoDeComprobante,
    currency.iso_code                         AS Moneda,
    CASE WHEN i.C_Currency_ID=130
        THEN ''
        ELSE TO_CHAR((currencyconvert(i.grandtotal, i.c_currency_id, 130, i.dateacct, i.c_conversiontype_id, i.ad_client_id, i.ad_org_id)/i.grandtotal),'00.000000')
        END                                  AS TipoCambio,
    (
        SELECT ad_ref_list_trl.description
        FROM AD_Ref_List_Trl
        WHERE AD_Ref_List_Trl.AD_language = 'es_MX'
        AND (AD_Ref_List_Trl.ad_ref_list_id IN ( SELECT AD_Ref_List.AD_Ref_List_ID FROM AD_Ref_List
        WHERE AD_Ref_List.AD_Reference_ID = 195 AND AD_Ref_List.Value = i.PaymentRule))
    )                                        AS FormaPago,
    tg.value                                 AS RegimenFiscal,
    lmxbp.usocfdi                            AS UsoCFDI
  FROM C_Invoice i
  INNER JOIN C_BPartner bp ON bp.C_BPartner_id=i.C_BPartner_ID
  INNER JOIN C_BPartner_Location bpl ON bpl.C_BPartner_Location_ID=i.C_BPartner_Location_ID
  LEFT JOIN C_Location l ON l.c_location_id=bpl.c_location_id
  LEFT JOIN LMX_Tax fi ON (fi.AD_Client_ID=i.AD_Client_ID)
    /*LEFT JOIN LMX_Tax fi
    ON fi.lmx_Tax_id =
    (SELECT lmx_tax_id
    FROM lmx_tax
    WHERE ad_tree_org_id IN
    (SELECT ad_tree_id
    FROM ad_tree
    WHERE ad_tree_id IN
    (SELECT ad_tree_id FROM ad_treenode WHERE node_id = i.ad_org_id
    )
    AND treetype = 'OO'
    )
    )*/
  LEFT JOIN C_Country c ON c.C_Country_id=l.C_Country_ID
  LEFT JOIN AD_OrgInfo o ON o.AD_Org_ID=i.AD_Org_ID
  LEFT JOIN C_Location ol ON ol.C_Location_ID=o.C_Location_ID
  LEFT JOIN C_Region rol ON rol.C_Region_ID=ol.C_Region_ID
  LEFT JOIN C_Country oc ON oc.C_Country_ID=ol.C_Country_id
    /*LEFT JOIN C_Location el
    ON el.c_location_id=
    (SELECT c_location_id
    FROM lmx_tax
    WHERE ad_tree_org_id IN
    (SELECT ad_tree_id
    FROM ad_tree
    WHERE ad_tree_id IN
    (SELECT ad_tree_id FROM ad_treenode WHERE node_id = i.ad_org_id
    )
    AND treetype = 'OO'
    )
    )*/
  LEFT JOIN C_Location el ON el.C_Location_ID=fi.C_Location_ID
  LEFT JOIN C_Region rel ON rel.C_Region_ID=el.C_Region_ID
  LEFT JOIN C_Country ec ON ec.C_Country_ID=el.C_Country_ID
  LEFT JOIN C_DocType dt ON dt.C_DocType_ID=i.C_DocTypeTarget_ID
  LEFT JOIN C_PaymentTerm pt ON pt.C_PaymentTerm_ID=i.C_PaymentTerm_ID
  LEFT JOIN AD_Sequence seq ON seq.AD_Sequence_ID=dt.DocNoSequence_ID
  LEFT JOIN LMX_Location oln ON oln.C_Location_ID = ol.C_Location_ID
  LEFT JOIN LMX_Location en ON en.C_Location_ID = el.c_Location_ID
  LEFT JOIN LMX_Location ln ON ln.c_Location_ID = l.c_Location_ID
  LEFT JOIN C_BPartner e ON fi.C_BPartner_ID = e.C_BPartner_ID
  LEFT JOIN C_TaxGroup tg ON e.C_TaxGroup_ID = tg.C_TaxGroup_ID
  LEFT JOIN C_Currency currency ON i.C_Currency_ID = currency.C_Currency_ID
  -- cfdi v3.3
  LEFT JOIN LMX_DocType lmxdt ON lmxdt.C_DocType_ID = dt.C_DocType_ID
  LEFT JOIN LMX_BPartner lmxbp ON lmxbp.C_BPartner_ID = bp.C_BPartner_ID;</RollbackStatement>
    </Step>
  </Migration>
</Migrations>
